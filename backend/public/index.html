<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Dashboard de Conteo de Personas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-4 text-center">Dashboard de Conteo de Personas</h1>

    <!-- ALERTAS DE CONGESTIÓN -->
    <div class="card mb-4">
      <div class="card-header">Últimas Alertas de Congestión</div>
      <div class="card-body">
        <ul class="list-group" id="alertas-list"></ul>
      </div>
    </div>
    <!-- FILTRO POR HORA -->
    <div class="mb-3">
      <label for="filtro-hora" class="form-label">Filtrar por hora:</label>
      <select id="filtro-hora" class="form-select" style="max-width: 300px;">
        <option value="">-- Ver todo --</option>
      </select>
    </div>

    <!-- GRILLA VISUAL DE CONTEO POR ZONA -->
    <div class="card mb-4">
      <div class="card-header">Visualización de Conteo por Zona</div>
      <div class="card-body">
        <div id="grid-zonas" class="d-flex flex-column align-items-center gap-2"></div>
      </div>
    </div>


    <!-- CONTEO POR ZONA -->
    <!-- <div class="card mb-4">
      <div class="card-header">Último Conteo por Zona</div>
      <div class="card-body">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Fila</th>
              <th>Columna</th>
              <th>Cantidad</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody id="conteo-table"></tbody>
        </table>
      </div>
    </div> -->

    <!-- HORA PICO -->
    <div class="card mt-4">
      <div class="card-header">Hora Pico de Detección</div>
      <div class="card-body">
        <canvas id="horaPicoChart"></canvas>
      </div>
    </div>


    <!-- TIEMPO PROMEDIO -->
    <div class="card">
      <div class="card-header">Tiempo Promedio por Zona</div>
      <div class="card-body">
        <canvas id="tiempoChart"></canvas>
      </div>
    </div>
  </div>

  <script>

    async function cargarHorasDisponibles() {
      const res = await fetch(`${API_BASE}/conteo`);
      const data = await res.json();

      const horas = [...new Set(data.map(d => new Date(d.timestamp).toTimeString().slice(0, 5)))].sort();
      const select = document.getElementById("filtro-hora");

      horas.forEach(hora => {
        const option = document.createElement("option");
        option.value = hora;
        option.textContent = hora;
        select.appendChild(option);
      });

      // Evento: al cambiar la hora, recarga la grilla
      select.addEventListener("change", (e) => {
        cargarVisualGrid(e.target.value);
      });
    }


    const API_BASE = "http://localhost:3000/api";

    async function cargarAlertas() {
      const res = await fetch(`${API_BASE}/alertas`);
      const data = await res.json();
      const lista = document.getElementById("alertas-list");
      lista.innerHTML = "";

      data.forEach(alerta => {
        const li = document.createElement("li");
        li.className = "list-group-item list-group-item-danger";

        const fechaHora = new Date(alerta.timestamp).toLocaleString();

        li.textContent = `Fila ${alerta.fila}, Columna ${alerta.columna} - Cantidad: ${alerta.cantidad} (${fechaHora})`;
        lista.appendChild(li);
      });
    }


    async function cargarConteo() {
      const res = await fetch(`${API_BASE}/conteo`);
      const data = await res.json();
      const tabla = document.getElementById("conteo-table");
      tabla.innerHTML = "";
      data.forEach(reg => {
        const row = `<tr>
          <td>${reg.fila}</td>
          <td>${reg.columna}</td>
          <td>${reg.cantidad}</td>
          <td>${new Date(reg.timestamp).toLocaleString()}</td>
        </tr>`;
        tabla.innerHTML += row;
      });
    }

    async function cargarVisualGrid(horaSeleccionada = "") {
      const res = await fetch(`${API_BASE}/conteo`);
      const data = await res.json();

      // Filtrado por hora (si se seleccionó una)
      const datosFiltrados = horaSeleccionada
        ? data.filter(d => {
          const hora = new Date(d.timestamp).toTimeString().slice(0, 5); // "HH:MM"
          return hora === horaSeleccionada;
        })
        : data;

      const filas = 2;
      const columnas = 2;
      const grid = Array.from({ length: filas }, () =>
        Array.from({ length: columnas }, () => 0)
      );

      datosFiltrados.forEach(d => {
        grid[d.fila][d.columna] = d.cantidad;
      });

      const gridContainer = document.getElementById("grid-zonas");
      gridContainer.innerHTML = "";

      grid.forEach((fila, i) => {
        const row = document.createElement("div");
        row.className = "d-flex justify-content-center gap-3";

        fila.forEach((valor, j) => {
          const celda = document.createElement("div");
          celda.className = "text-center rounded p-3 shadow-sm fw-bold";
          celda.style.width = "100px";
          celda.style.height = "100px";
          celda.style.display = "flex";
          celda.style.alignItems = "center";
          celda.style.justifyContent = "center";
          celda.style.flexDirection = "column";

          if (valor >= 10) {
            celda.style.backgroundColor = "#dc3545";
            celda.style.color = "white";
          } else if (valor >= 5) {
            celda.style.backgroundColor = "#ffc107";
            celda.style.color = "#212529";
          } else {
            celda.style.backgroundColor = "#198754";
            celda.style.color = "white";
          }

          celda.innerHTML = `<div>(${i},${j})</div><div>${valor} personas</div>`;
          row.appendChild(celda);
        });

        gridContainer.appendChild(row);
      });
    }

    async function cargarHoraPico() {
  const res = await fetch(`${API_BASE}/hora-pico`);
  const data = await res.json();

  const horas = data.map(d => `${d.hora_minuto}:00`); // aquí va hora_minuto, no hora
  const cantidades = data.map(d => d.cantidad);

  new Chart(document.getElementById("horaPicoChart"), {
    type: 'line',
    data: {
      labels: horas,
      datasets: [{
        label: 'Personas detectadas',
        data: cantidades,
        fill: true,
        borderColor: '#198754',
        backgroundColor: 'rgba(25, 135, 84, 0.2)',
        tension: 0.3,
        pointBackgroundColor: '#198754'
      }]
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Cantidad de personas'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Hora del día'
          }
        }
      }
    }
  });
}



    async function cargarTiempoPromedio() {
      const res = await fetch(`${API_BASE}/tiempo`);
      const data = await res.json();

      const etiquetas = data.map(d => `(${d.fila},${d.columna})`);
      const valores = data.map(d => d.tiempo_promedio.toFixed(1));

      new Chart(document.getElementById("tiempoChart"), {
        type: 'bar',
        data: {
          labels: etiquetas,
          datasets: [{
            label: 'Tiempo promedio (s)',
            data: valores,
            backgroundColor: '#007bff'
          }]
        },
        options: {

          scales: {
            y: {
              ticks: {
                callback: function (value) {
                  const minutes = Math.floor(value / 60);
                  const seconds = Math.floor(value % 60);
                  return `${minutes}:${seconds.toString().padStart(2, '0')} min`;
                }
              },
              title: {
                display: true,
                text: 'Tiempo promedio (min:seg)'
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      const valor = context.raw;
                      const d = data[context.dataIndex];
                      const minutos = Math.floor(valor / 60);
                      const segundos = Math.floor(valor % 60);
                      return `Tiempo promedio: ${minutos}:${segundos.toString().padStart(2, '0')} min (${d.cantidad_personas} personas)`;
                    }
                  }
                }
              }

            }
          }
        }

      });
    }

    cargarAlertas();
    // cargarConteo();
    cargarHoraPico();
    cargarTiempoPromedio();
    cargarHorasDisponibles();
    cargarVisualGrid();
  </script>
</body>

</html>